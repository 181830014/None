{% extends 'layout.html' %}
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>{% block title %}{{title}}{% endblock %}</title>
    {% block headcss %}<link rel="stylesheet" href="/css/tanke.css" />{% endblock %}
</head>
<body class="">
    {% block content %}{% spaceless %}
    <div id="js-main" class="main">

        <div id="js-game" class="game-container">
            <div id="js-container">
                <div id="js-canvas-cont">
                </div>
                <div id="js-head-bar" class="head-bar">
                    <div id="js-head-icon" class="head-hdicon">
                        <img id="js-head-body" class="head-img-body" src="/p/tk1.png" />
                        <img id="js-head-pao" src="/p/gp0.png" />
                    </div>
                    <div class="head-info">
                        <div class="head-health">
                            <div id="js-head-health"></div>
                        </div>
                        <div id="js-gold" class="head-gold"><span id="js-gold-num">0</span></div>
                    </div>
                </div>
                <div id="js-rank-bar" class="game-top-right">
                    <div class="rank-bar">
                        <ul class="rank-list">
                            <li class="rank-head">
                                <span class="sp1">排名</span>
                                <span class="sp2">玩家</span>
                                <span class="sp3">杀敌</span>
                                <span class="sp4">金币</span>
                            </li>
                        </ul>
                        <ul id="js-rank-list" class="rank-list">
                            <li>
                                <span class="sp1">#-</span>
                                <span class="sp2">-</span>
                                <span class="sp3">-</span>
                                <span class="sp4">-</span>
                            </li>
                            <li class="rank-you">
                                <span class="sp1">#-</span>
                                <span class="sp2">-</span>
                                <span class="sp3">-</span>
                                <span class="sp4">-</span>
                            </li>
                        </ul>
                    </div>
                    <div class="top-btns">
                        <div id="js-game-fulscr" class="icon-btn fulscr"></div>
                    </div>
                </div>
                
                <div id="js-touch-bar" class="touch-bar">
                    <div id="js-touch-ring" class="touch-ring">
                        <div id="js-touch-point" class="touch-point"></div>
                    </div>
                </div>
                <div id="js-kill-bd" class="game-kill-borad">
                    <!--<div class="kill-line">
                        <span>YOU</span> <a>killed</a> <span>AGSFS</span>
                    </div>-->
                </div>
                <div id="js-guns" class="game-guns-d">
                    <div class="close-d"></div>
                    <div class="game-guns-ct">
                        <img class="game_guns-linebg" src="/p/bgl.png" />
                        <div id="js-guns-div" class="game-guns-list">
                            <div class="g-item">
                                <div class="g-item-body">
                                    <img class="js-p-img" />
                                </div>
                                <div class="g-item-price">$0</div>
                                <div class="g-item-name"></div>
                                <div class="g-item-buy">购买</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="js-main-page" class="main-page" v-bind:class="{'hide':sysstate==2}">
            <div class="first-input-page">
                <div class="logo-div">{{bgtitle}}</div>
                <div class="input-cont">
                    <input id="ipt-name" type="text" maxlength="30" v-on:keyup.13="play()" v-model="userName" placeholder="pick a name" />
                    <div id="js-btn-start" class="btn-start" v-on:click="play()">
                        <span>Play</span>
                        <div id="js-connecting" class="conn-ing" v-bind:class="{'show':sysstate==1}"></div>
                    </div>
                </div>
            </div>
            <div class="other-page">
                {% raw %}
                <div id="js-chat-wrap" class="chat-wrap">
                    <div class="chat-title">
                        <span>CHATROOM</span>
                    </div>
                    <div id="js-chat-room" class="chat-room">
                        <div id="js-chat-msgs" class="chat-msgs">
                            <p v-for="prow in chatRoom.msg" class="chat-row" data-uid="{{prow.i}}">
                                <span class="chat-time">[{{prow.t}}]</span>
                                <span class="chat-user" v-bind:class="{'chat-sys':(prow.u==1)}">{{prow.n}}</span>
                                <span class="chat-txt">{{prow.v}}</span>
                            </p>
                        </div>
                        <div class="chat-iptd">
                            <div class="chat-ipt-ct">
                                <input id="js-chat-input" type="text" v-model="chatRoom.ipt" v-on:keyup.13="send($event)" maxlength="100" class="chat-ipt" />
                            </div>
                            <div class="chat-send" v-on:click="send()">send</div>
                        </div>
                    </div>
                </div>
                {% endraw %}
                <div style="text-align:center;line-height:500px;display:none;">一切都在开发之中。</div>
            </div>
        </div>
    </div>

    {% endspaceless %}{% endblock %}
    <!-- 这里在页面中会被忽略 这样写只为启用visualstudio的代码提示功能 -->
    <script src="/public/js/jquery-1.11.1.min.js"></script>
    <script src="/public/js/vue.js"></script>
    <script src="/public/js/pixi.js"></script>
    <script src="/public/js/socketio_145.js"></script>
    {% block footjs %}
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script src="/js/vue.js"></script>
    <script src="/js/pixi.min.js"></script>
    <script src="/js/socketio_145.js"></script>
    {% jsmin "-oa /js/tank.js -b -ua" %}
    <script>
        // jsmin 的参数  -o 表示导出到/js/tank.js  ， -b 表示使用闭包   ，  -u 表示不压缩


        // 在开发状态下
        // 建议在app.js中找到这行
        // “//swig.setDefaults({ cache: false });”
        // 取消注释   从而禁用缓存


        var lang = navigator.language || navigator.userLanguage,
            lang = lang.substr(0, 2)
          , ua = navigator.userAgent.toLowerCase()
          , is_android = 0 <= ua.indexOf("android")
          , is_amazon = 0 <= ua.indexOf("kindle") || 0 <= ua.indexOf("silk/")
          , uua = navigator.userAgent
          , is_ios = 0 <= uua.indexOf("iPad") || 0 <= uua.indexOf("iPhone") || 0 <= uua.indexOf("iPod")
          , is_mobile = 0 <= ua.indexOf("mobile")
          , is_firefox = -1 < ua.indexOf("firefox")
          , is_ie8oo = window.attachEvent && !window.addEventListener
          , is_chrome = false
          , is_safari = false;
            0 <= ua.indexOf("safari") && -1 == ua.indexOf("chrome") && (is_safari = true);
            0 <= ua.indexOf("chrome") && (is_safari || is_firefox || (is_chrome = true));



        //copycode(wsserver/tools.js)
        var tools = {};
        tools.deg2vector = function () {
            var degreeToRadiansFactor = Math.PI / 180;
            return function (deg, rst) {
                var result = rst || { x: 0, y: 0 };
                var rad = (deg % 360) * degreeToRadiansFactor;
                result.y = Math.round(Math.sin(rad) * 1000) / 1000;
                result.x = Math.round(Math.cos(rad) * 1000) / 1000;
                return result;
            }
        }();
        tools.vector2deg = function () {
            var radianToDegreesFactor = 180 / Math.PI;
            return function (x, y) {
                if (x == 0 && y == 0) {
                    return 360;
                }
                rad = Math.atan(y / x);
                var result = rad * radianToDegreesFactor;
                if (x < 0) {
                    result += 180;
                }
                if (result < 0) {
                    result += 360;
                }
                return result;
            }
        }();
        tools.w2level = function (w) {  //w经验转等级
            w = w << 1;
            var m = Math.floor(Math.sqrt(w));
            if (w < m * m + m) {
                return m - 1;
            }
            return m;
        }
        tools.level2w = function (level) {
            return Math.round((level * level) + level / 2);
        }
        tools.w2health = function (w) {  //w经验转生命值
            return tools.level2health(tools.w2level(w));
        }
        tools.level2health = function (lv) {  //w经验转生命值
            return 10 + (lv << 1);
        }
        function clone(myObj) {
            if (typeof (myObj) != 'object') return myObj;
            if (myObj == null) return myObj;

            var myNewObj;
            if (myObj.constructor) {
                myNewObj = new myObj.constructor();
            } else
                myNewObj = {}
            for (var i in myObj)
                myNewObj[i] = clone(myObj[i]);
            return myNewObj;
        }
        tools.clone = clone;
        /*copycode
        module.exports = tools;
        */
        //endcopycode

        var Blob = window.Blob || window.webkitBlob;
        function str2blob(str) {
            var b = new Blob([str], {});// "type": "text/plan"
            return b;
        }
        function str2ab(str) {
            var buf = new ArrayBuffer(str.length); // 2 bytes for each char
            var bufView = new Uint8Array(buf);
            for (var i = 0, strLen = str.length; i < strLen; i++) {
                bufView[i] = str.charCodeAt(i);
            }
            return buf;
        }
        function getData(data, callback) {
            if ("string" == typeof data) {
                if (callback instanceof Function) {
                    callback(data);
                }
            } else if (data instanceof ArrayBuffer) {
                var b = new Blob([data]);
                var f = new FileReader();
                f.onload = function () {
                    if (callback instanceof Function) {
                        callback(this.result);
                    }
                }
                f.readAsText(b);
            } else if (data instanceof Blob) {
                var f = new FileReader();
                f.onload = function () {
                    if (callback instanceof Function) {
                        callback(this.result);
                    }
                }
                f.readAsText(data);
            }
        }
        if (location.hostname == "tank.xiwnn.com") {
            var wsuri = "ws://t.xiwnn.com:8008/";
        } else {
            var wsuri = "ws://" + location.hostname + ":8008/";
        }
        var socket = {};
        (function (socket) {
            var ws = {};
            var isonline = false;

            var defaulturl = wsuri;

            this.emit = function (title, data) {
                //return this.emitStr(title, data);
                if (ws.readyState == 1)
                    ws.send(str2blob(title + data));
            }
            this.emitStr = function (title, data) {
                if (ws.readyState == 1)
                    ws.send(title + data);
            }
            function call(data) {
                if (data[0] != "z") {
                    serverMessage(data);
                } else {
                    //data = data.substr(1);
                    //console.log(wsuri.replace(":8008", ":" + data.substr(1)))
                    ws.close();
                    isonline = false;
                    redirect(wsuri.replace(":8008", ":" + data.substr(1)));
                }
            }
            function connect(url) {
                if (isonline) {
                    return;
                }
                isonline = true;
                var thews = new WebSocket(url);
                ws = thews;
                //window.ws = ws;
                //ws.binaryType = "arraybuffer";
                thews.binaryType = "blob";

                thews.onmessage = function (event) {
                    getData(event.data, call);
                }
                thews.onopen = function (event) {
                    ws_open();
                }
                thews.onerror = function (event) {
                    console.log("error")
                }
                thews.onclose = function (event) {
                    console.log("close");
                    if (ws == thews) {
                        isonline = false;
                        ws_close();
                    }
                }
            }
            function redirect(data) {
                connect(data);
            }
            this.connect = function () {
                connect(defaulturl);
            }
            //setInterval(function () {
            //    if (isonline && ws.send) {
            //        ws.send("2");
            //    }
            //}, 10000);
        }).bind(socket)(socket);

        //socket.connect();
    </script>

    <script>

        //copycode(wsserver/guns.js)
        var GUNS = { "0": { "n": "土炮", "m": "", "pr": 0, "p": "p0", "fires": [{ "tx": 25, "ty": 0, "tr": 0, "d": 500, "v": 35, "ct": 0, "tt": 1000, "st": 0, "k": 1, "img": "zd0" }], "lf": 115, "tp": 0 }, "1": { "n": "快枪", "m": "", "pr": 10, "p": "p1", "fires": [{ "tx": 25, "ty": 0, "tr": 0, "d": 500, "v": 40, "ct": 0, "tt": 500, "st": 0, "k": 1, "img": "zd0" }], "lf": 1, "tp": 108 }, "2": { "n": "机枪", "m": "", "pr": 10, "p": "p5", "fires": [{ "tx": 26, "ty": 0, "tr": 0, "d": 500, "v": 45, "ct": 0, "tt": 300, "st": 0, "k": 1, "img": "zd0" }], "lf": 1, "tp": 216 }, "3": { "n": "双枪", "m": "", "pr": 10, "p": "p2", "fires": [{ "tx": 25, "ty": -7, "tr": 0, "d": 500, "v": 40, "ct": 0, "tt": 1000, "st": 0, "k": 1, "img": "zd0" }, { "tx": 25, "ty": 6, "tr": 0, "d": 500, "v": 40, "ct": 0, "tt": 1000, "st": 0, "k": 1, "img": "zd0" }], "lf": 77, "tp": 108 }, "4": { "n": "三管枪", "m": "", "pr": 10, "p": "p6", "fires": [{ "tx": 24, "ty": -12, "tr": -2, "d": 500, "v": 45, "ct": 0, "tt": 800, "st": 0, "k": 1, "img": "zd0" }, { "tx": 25, "ty": 0, "tr": 0, "d": 500, "v": 45, "ct": 0, "tt": 800, "st": 0, "k": 1, "img": "zd0" }, { "tx": 24, "ty": 12, "tr": 2, "d": 500, "v": 45, "ct": 0, "tt": 800, "st": 0, "k": 1, "img": "zd0" }], "lf": 77, "tp": 216 }, "5": { "n": "粗管枪", "m": "", "pr": 10, "p": "p3", "fires": [{ "tx": 25, "ty": 0, "tr": 0, "d": 500, "v": 40, "ct": 0, "tt": 1000, "st": 0, "k": 2, "img": "zd2" }], "lf": 153, "tp": 108 }, "6": { "n": "粗管枪2", "m": "", "pr": 10, "p": "p7", "fires": [{ "tx": 25, "ty": 0, "tr": 0, "d": 550, "v": 45, "ct": 0, "tt": 800, "st": 0, "k": 3, "img": "zd2" }], "lf": 153, "tp": 216 }, "7": { "n": "长枪", "m": "", "pr": 10, "p": "p4", "fires": [{ "tx": 30, "ty": 0, "tr": 0, "d": 700, "v": 40, "ct": 0, "tt": 1000, "st": 0, "k": 1, "img": "zd0" }], "lf": 229, "tp": 108 }, "8": { "n": "长枪", "m": "", "pr": 10, "p": "p8", "fires": [{ "tx": 30, "ty": 0, "tr": 0, "d": 700, "v": 45, "ct": 0, "tt": 800, "st": 0, "k": 1, "img": "zd0" }], "lf": 229, "tp": 216 } }




        for (var gi in GUNS) {
            var gg = GUNS[gi];
            for (var ggi in gg.fires) {
                var ghi = gg.fires[ggi];
                ghi.ct = Math.floor(ghi.d * 100 / ghi.v);
                ghi.f_t = ghi.st;
            }
        }

        //GUNS['0'] = GUNS['5'];

        /*copycode
        module.exports = GUNS;
        */
        //endcopycode

        (function () {
            var guns_div = $("#js-guns-div");
            var g_templt = guns_div.html();
            guns_div.empty();
            
            for (var gi in GUNS) {
                var gn = GUNS[gi];
                var gnode = $(g_templt);
                gnode[0].id = "g_" + gi;
                gnode.find(".js-p-img").attr("src", "/p/" + gn.p + ".png");
                gnode.find(".g-item-name").text(gn.n);
                gnode.find(".g-item-price").text("$"+gn.pr);
                gnode.css({ top: gn.tp, left: gn.lf });
                guns_div.append(gnode);
            }

        })();
        

        //copycode(wsserver/wuti.js)
        var WUTIS = {
            "t_p": 0,    //掉落金币的道具
            "t_t": 1,    //掉落加速加血的道具
            "t_m": 2,    //移动的物体
            "t_g": 3,    //静止的自动炮
            "t_z": 4,    //追踪弹
            0: {
                g: 16,  //概率权重
                t: 0,   //类型
                img: "wt0",
                rd: 15,
                h: 2,
                v: 1,   //分数+
            },
            1: {
                g: 11,
                t: 0,   //类型
                img: "wt2",
                rd: 15,
                h: 4,
                v: 2,   //分数+
            },
            2: {
                g: 7,
                t: 0,   //类型
                img: "wt3",
                rd: 15,
                h: 7,
                v: 4,   //分数+
            },
            3: {
                g: 4,
                t: 0,   //类型
                img: "wt4",
                rd: 15,
                h: 11,
                v: 6,   //分数+
            },
            4: {
                g: 2,
                t: 0,   //类型
                img: "wt5",
                rd: 15,
                h: 16,
                v: 10,   //分数+
            },
            5: {
                g: 1,
                t: 0,   //类型
                img: "wt6",
                rd: 15,
                h: 22,
                v: 16,   //分数+
            },
            10: {
                g: 30,
                t: 1,   //类型
                img: "wt1",
                rd: 15,
                h: 3,
                v: 1,   //分数+
            },

            suiji: []
        };
        (function () {
            var wi_count = 0;
            for (var wi in WUTIS) {
                if (WUTIS[wi].g !== undefined) {
                    wi_count += WUTIS[wi].g;
                }
            }
            var gailv = 0;
            for (var wi in WUTIS) {
                if (WUTIS[wi].g !== undefined) {
                    gailv += WUTIS[wi].g / wi_count;
                    WUTIS.suiji.push(gailv, wi);
                }
            }
        })();
        /*copycode
        module.exports = WUTIS;
        */
        //endcopycode

        //copycode(wsserver/jiangpin.js)
        var JIANGPINS = {
            "type_g": 0,    //金币
            "type_v": 1,      //加速
            "type_bottle": 2,   //药瓶
            "type_gun": 3,        //枪
            "type_invincible": 4, //无敌
            0: {
                type: 0,
                img: "jpg",
                radius: 20,
            },
            1: {
                type: 1,
                img: "jpv",
                radius: 20,
            },
            2: {
                type: 2,
                img: "jpy",
                radius: 20,
            },
            3: {
                type: 3,
                img: "jpb",
                radius: 20,
                value:"b",
            },
            4: {
                type: 0,
                img: "jpg",
                radius: 20,
            },
            5: {
                type: 3,
                img: "jpg",
                radius: 20,
            }
        }
        /*copycode
        module.exports = JIANGPINS;
        */
        //endcopycode

        var textures_path = "p/";
        var textures_houzhui = ".png";
        var texture_bg = textures_path + "bg2.png";
        var texture_bg_1_2 = textures_path + "bg_1_2.png";
        var textures = {
            //飞机
            "fj0": "tk1",
            "fj0_p": "gp0",

            //炮塔

            "p0": "p0", "p1": "p1", "p4": "p4", "p7": "p7", "p12": "p12", "p13": "p13", "p11": "p11", "p14": "p14", "p15": "p15", "p5": "p5", "p9": "p9", "p6": "p6", "p8": "p8", "p10": "p10", "p2": "p2", "p3": "p3"


            //子弹
            ,"zd0": "zd0",
            "zd1": "zd1",
            "zd2": "zd2",
            "zd3": "zd3",
            "zd4": "zd4",


            //奖品
            "jpy": "jp_y",
            "jpv": "jp_v",
            "jpb": "jp_b",
            "jpg": "jp_g",

            //物品
            "wt0": "wt_0",
            "wt1": "wt_1",
            "wt2": "wt_2",
            "wt3": "wt_3",
            "wt4": "wt_4",
            "wt5": "wt_5",
            "wt6": "wt_6",
        }
        for (var ti in textures) {
            textures[ti] = "p/" + textures[ti] + ".png";
        }
        var texture_img = tools.clone(textures);

    </script>

    <script>



        var pageData = {
            suportWS: "WebSocket" in window,
            sysstate: 0, //0表示未开始 1表示等待中  2表示已经开始
            playing: false,
            userName: "",
            chatRoom: {
                msg: [
                    //{ i:"xxxx id", u: 0, n: "name", v: "aaaaaaaaaaaaaaaaaasdffffffffffffffffaaaaaa" },
                ],
                ipt:"",
            }
        };
        //window.pageData = pageData;
        if (window.localStorage) {
            var dfuname = localStorage.getItem("username");
            if (dfuname) {
                pageData.userName = dfuname;
            }
        }

        function chat_load_beforedata() {
            $.ajax({
                url: "chatdata",
                dataType: "json",
                success: function (data) {
                    chat_add(data,true);
                },
                error: function (data) {

                }
            })
        }

        var chat_socket = io("/");
        var chat_myid = "";
        chat_socket.on("m", function (data) {
            //console.log(data);
            chat_add(data);
        });
        chat_socket.on("y", function (data) {
            chat_myid = data.id;
        });

        var js_chat_msg_cont = document.getElementById("js-chat-msgs");
        var js_chat_wrap = $("#js-chat-wrap");
        var js_chat_room = $("#js-chat-room");
        var js_container = $("#js-container");
        var js_chat_input = $("#js-chat-input");
        var js_is_pc = true;
        (function () {
            var sUserAgent = navigator.userAgent.toLowerCase();
            var bIsIpad = sUserAgent.match(/ipad/i) == "ipad";
            var bIsIphoneOs = sUserAgent.match(/iphone os/i) == "iphone os";
            var bIsMidp = sUserAgent.match(/midp/i) == "midp";
            var bIsUc7 = sUserAgent.match(/rv:1.2.3.4/i) == "rv:1.2.3.4";
            var bIsUc = sUserAgent.match(/ucweb/i) == "ucweb";
            var bIsAndroid = sUserAgent.match(/android/i) == "android";
            var bIsCE = sUserAgent.match(/windows ce/i) == "windows ce";
            var bIsWM = sUserAgent.match(/windows mobile/i) == "windows mobile";
            if ((bIsIpad || bIsIphoneOs || bIsMidp || bIsUc7 || bIsUc || bIsAndroid || bIsCE || bIsWM)) {
                js_is_pc = false;
                $("#js-game").addClass("touch");
            }
        })();
        function chat_add(data ,byajax) {
            var sctobtn = (js_chat_msg_cont.scrollTop == js_chat_msg_cont.scrollHeight - js_chat_msg_cont.clientHeight)
            if (byajax) {
                pageData.chatRoom.msg = data.concat(pageData.chatRoom.msg);
            } else {
                pageData.chatRoom.msg.push(data);
            }
            if (pageData.chatRoom.msg.length > 500) {
                pageData.chatRoom.msg.splice(2);
            }
            if (sctobtn) {
                setTimeout(function () {
                    js_chat_msg_cont.scrollTop = js_chat_msg_cont.scrollHeight - js_chat_msg_cont.clientHeight;
                }, 10);
            }
        }

        var pagevue = new Vue({
            el: '#js-main-page',
            data: pageData,
            methods: {
                play: function () {
                    if (pageData.sysstate == 0) {
                        pageData.sysstate = 1;
                        socket.connect();
                    }
                    if (window["localStorage"]) {
                        localStorage.setItem("username", pageData.userName);
                    }
                    if (_hmt) {
                        _hmt.push(['_trackEvent', 'shouye', 'play', 'play', 1]);
                    }
                },
                send: function (e) {
                    if (this.sysstate == 2) {
                        js_chat_input.blur();
                        if (e) {
                            e.stopPropagation();
                        }
                    }
                    if (this.chatRoom.ipt == "") {
                        return;
                    }
                    chat_socket.emit("s", {
                        n: pageData.userName,
                        v: pageData.chatRoom.ipt
                    });

                    //this.chat_add({
                    //    u: 0,
                    //    n: "me",
                    //    v: pageData.chatRoom.ipt
                    //});
                    
                    this.chatRoom.ipt = "";
                },
                chat_add: function (data) {
                    var sctobtn = (js_chat_msg_cont.scrollTop==js_chat_msg_cont.scrollHeight-js_chat_msg_cont.clientHeight)
                    pageData.chatRoom.msg.push(data);
                    if (pageData.chatRoom.msg.length > 50) {
                        pageData.chatRoom.msg.shift();
                    }
                    if (sctobtn) {
                        setTimeout(function () {
                            js_chat_msg_cont.scrollTop = js_chat_msg_cont.scrollHeight - js_chat_msg_cont.clientHeight;
                        }, 10);
                    }
                }
            }
        });
        $(function () {
            $("#ipt-name").focus();
            chat_load_beforedata();
        });

        var js_kill_bd = $("#js-kill-bd");
        function gui_top_msg(htmlstr) {
            var hdom = $("<div class='kill-line'>"+htmlstr+"</div>");
            js_kill_bd.append(hdom);
            setTimeout(function () {
                hdom.css("margin-top", "-" + (hdom.height() + 3) + "px");
            },2700);
            setTimeout(function () {
                hdom.remove();
            }, 3000);
        }
        function gui_show_kill(a, b) {
            gui_top_msg("<span>" + a + "</span><a>killed</a><span>" + b + "</span>");
        }

        var js_head_bar = $("#js-head-bar");
        var js_game_fulscr = $("#js-game-fulscr");
        var js_head_icon = $("#js-head-icon");
        var js_guns = $("#js-guns");
        var js_head_body = $("#js-head-body");
        var js_head_pao = $("#js-head-pao");
        var js_head_h = $("#js-head-health");
        var js_head_gold = $("#js-gold-num");
        var js_rank_list = $("#js-rank-list");
        var js_rank_tmp = '<li><span class="sp1">#@${i}</span><span class="sp2">@${n}</span><span class="sp3">@${k}</span><span class="sp4">@${g}</span></li>';
        var js_rank_tmp2 = '<li class="rank-you"><span class="sp1">#@${i}</span><span class="sp2">@${n}</span><span class="sp3">@${k}</span><span class="sp4">@${g}</span></li>';
        function gui_clear() {
            js_head_pao.attr("src", texture_img["fj0_p"]);
            js_head_h.css("width", "100%");
            js_head_gold.text(0);
            var t = js_rank_tmp.replace("@${i}", "-").replace("@${n}", "-").replace("@${k}", "-").replace("@${g}", "-")
            js_rank_list.html(t)
        }
        function gui_ud_gun() {

        }
        function gui_ud_h() {
            if (my_tank.h != undefined) {
                js_head_h.css("width", my_tank.h /dfd_h * 100 + "%");
            }
        }
        function gui_ud_gold() {
            if (my_tank.gold) {
                js_head_gold.text(my_tank.gold);
            }
        }
        function gui_ud_rank(data) {
            try{
                data = JSON.parse(data);
                var hstr = "";
                for (var i = 0; i < data.length; i++) {
                    hstr += js_rank_tmp.replace("@${i}", i + 1).replace("@${k}", data[i].k).replace("@${g}", data[i].g).replace("@${n}", function () { return data[i].n });
                }
                if (my_tank.n) {
                    hstr += js_rank_tmp2.replace("@${i}", my_tank.idx||"?").replace("@${k}", my_tank.kill).replace("@${g}", my_tank.gold).replace("@${n}", function () { return my_tank.n });
                }
                js_rank_list.html(hstr);
            } catch (e) {

            }
        }

        js_head_icon.click(function () {
            js_guns.addClass("show");
        });
        $(".close-d").click(function () {
            js_guns.removeClass("show");
        });
        js_guns.on("click", ".g-item-buy", function (e) {
            var id = $(this).parent().attr("id").replace("g_", "");
            Tank.ibg(id);
            js_guns.removeClass("show");
        });
        function launchFullScreen(element) {
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.mozRequestFullScreen) {
                element.mozRequestFullScreen();
            } else if (element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) {
                element.msRequestFullscreen();
            }
        }
        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozExitFullScreen) {
                document.mozExitFullScreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            }
        }
        
        js_game_fulscr.click(function () {
            var fdom = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullscreenElement || false;
            if (fdom) {
                exitFullscreen()
            } else {
                launchFullScreen(document.body)
            }
        });


        //copycode(wsserver/public.js)

        /*copycode
        var tools = require('./tools.js');
        var GUNS = require('./guns.js');
        var WUTIS = require('./wuti.js');
        var JIANGPINS = require('./jiangpin.js');
        */
        var main, ids, jp_ids, wt_ids;
        var game_env = 0;   //0：客户端   1：main    2:referee
        var game_is_ai = false;
        var game_width = 5000, game_height = 5000;
        var dft_speed = 12, dft_add_speed = 8; dfd_speed_t = 8000;
        var dfd_h = 10;

        var tk_juli = 20;
        var tk_jp_juli = tk_juli + 40;

        var ai_m_tank, ai_m_wuti, ai_m_jiangpin;
        var ai_min_tk, ai_min_wt, ai_min_jp;

        /*copycode
        //is_client = false;
        //is_server = true;
        */
        var my_id = "---";
        var my_tank = { x: 0, y: 0, kill: 0 };
        var tankes = {};    //坦克列表
        var zidans = [];    //子弹数组
        var wutis = {};     //物体列表
        var jiangpins = {};   //战利品列表
        var fj_time = 0;

        function ws_open() {

        }
        
        function ws_game_open() {
            pageData.sysstate = 2;
            fj_time = new Date().getTime();
            //js_chat_room.appendTo(js_container);
            //js_chat_msg_cont.scrollTop = js_chat_msg_cont.scrollHeight - js_chat_msg_cont.clientHeight;
        }
        function ws_close() {
            Tank.clear();
            Tank.ifire(false);
            Tank.ipao(0);
            Tank.imove(0);
            JiangPin.clear();
            WuTi.clear();
            gui_clear();
            pageData.sysstate = 0;
            fj_time = 0;

            //js_chat_room.appendTo(js_chat_wrap);
            //js_chat_msg_cont.scrollTop = js_chat_msg_cont.scrollHeight - js_chat_msg_cont.clientHeight;
            //if (pageData.userName == "imai") {
            //    setTimeout(function () {
            //        pagevue.play();
            //    }, 1000);
            //}
        }


        function JiangPin(data) {
            var tp = {
                id: 0, //物品id   1位字符
                t: 1, //类型id  对应JIANGPINS中的类型id
                x: 0,
                y: 0,
                r: 0,   //方向
                rd: 10,  //半径 radius
                v: 0,   //物品的移动速度
                a: true,    //is active
                b: true,    //辅助
                m_t: 0, //上一次移動的時間
                v_v: null,   //速度的基础向量
                z: 0,   //值  金币就表示金币数量
                fj_tk: "",
            }
            for (var i in data)
                if (tp[i] !== undefined)
                    tp[i] = data[i];

            tp.rd = JIANGPINS[tp.t].radius;
            tp.img = JIANGPINS[tp.t].img;

            if (tp.m_t == 0) {
                tp.m_t = new Date().getTime();
            }
            tp.v_v = tools.deg2vector(tp.r);

            for (var gi in tp) {
                this[gi] = tp[gi];
            }

            this.chi = false;
            this.chi_ct = 0.1;

            JiangPin.remove(this.id);
            jiangpins[this.id] = this;
            this.add_fj();
        }
        JiangPin.prototype.remove = function () {
            if (this.model) {
                this.model.destroy({ children: true });
            }
            delete jiangpins[this.id];
            if (game_env == 1) {
                jp_ids.free(this.id);
            }
        }
        JiangPin.prototype.getZipStr = function () {
            if (this.zipstr)
                return this.zipstr
            var str = this.id +
            String.fromCharCode(Math.round(this.x) + 32768) +
            String.fromCharCode(Math.round(this.y) + 32768) +
            String.fromCharCode((this.r << 7) + this.t) +
            String.fromCharCode(this.z)
            return this.zipstr = str;
        }
        JiangPin.prototype.add_fj = function () {
            var tk, fj_ds = Tank.fj_dswj;
            for (var ti in tankes) {
                tk = tankes[ti];
                if (Math.abs(tk.x - this.x) < fj_ds && Math.abs(tk.y - this.y) < fj_ds) {
                    tk.fj_jp += this.id;
                    this.fj_tk += ti;
                }
            }
        }
        JiangPin.add = function (data) {
            return new JiangPin(data);
        }
        JiangPin.random = function (id) {
            var rd1 = Math.random();
            if (rd1 < 0.5) {
                return JiangPin.add({
                    id: id || Math.floor(Math.random() * 100000) + "",
                    x: Math.random() * game_width * 2 - game_width,
                    y: Math.random() * game_height * 2 - game_height,
                    r: Math.floor(Math.random() * 360),
                    t: 0,
                    z: Math.floor(Math.random() * 3) +1,
                });
            } else {
                var rdm = Math.random();
                var t = rdm < 0.4 ? 2 : 1;  //血瓶更少 加速更多
                return JiangPin.add({
                    id: id || Math.floor(Math.random() * 100000) + "",
                    x: Math.random() * game_width * 2 - game_width,
                    y: Math.random() * game_height * 2 - game_height,
                    r: Math.floor(Math.random() * 360),
                    t: t
                });
            }
        }
        JiangPin.randomXY = function (id ,x ,y) {
            var rdm = Math.random();
            var t = rdm < 0.4 ? 2 : 1;

            x > game_width ? x = game_width : (x < -game_width ? x = -game_width : 0);
            y > game_height ? y = game_height : (y < -game_height ? y = -game_height : 0);
            return JiangPin.add({
                id: id || Math.floor(Math.random() * 100000) + "",
                x: x,
                y: y,
                r: Math.floor(Math.random() * 360),
                t: t
            });
        }
        JiangPin.setSpeedUp = function (id, x, y) {
            x > game_width ? x = game_width : (x < -game_width ? x = -game_width : 0);
            y > game_height ? y = game_height : (y < -game_height ? y = -game_height : 0);
            return JiangPin.add({
                id: id || Math.floor(Math.random() * 100000) + "",
                x: x,
                y: y,
                r: Math.floor(Math.random() * 360),
                t: 1,
            });
        }
        JiangPin.setGold = function (id, gold, x, y) {
            var t = 0;
            x > game_width ? x = game_width : (x < -game_width ? x = -game_width : 0);
            y > game_height ? y = game_height : (y < -game_height ? y = -game_height : 0);
            return JiangPin.add({
                id: id || Math.floor(Math.random() * 100000) + "",
                x: x,
                y: y,
                r: Math.floor(Math.random() * 360),
                t: t,
                z: gold,
            });
        }
        JiangPin.setByWu = function (id, wu) {
            var t = 0, g = 1;
            if (WUTIS[wu.t]) {
                if (WUTIS[wu.t].t == 0) {   //金币类
                    g = WUTIS[wu.t].v || 1;
                    return JiangPin.add({
                        id: id || Math.floor(Math.random() * 100000) + "",
                        x: wu.x,
                        y: wu.y,
                        r: Math.floor(Math.random() * 360),
                        t: t,
                        z: g,
                    });
                } else if (WUTIS[wu.t].t == 1) {    //加速加血道具类
                    return JiangPin.randomXY(id, wu.x, wu.y);
                }
            }
            jp_ids.free(id);
        }
        JiangPin.remove = function (jpid) {
            var jp = jiangpins[jpid]
            if (jp) {
                jp.remove();
            }
        }
        JiangPin.clear = function () {
            for (var ti in jiangpins) {
                JiangPin.remove(ti);
            }
        }
        JiangPin.getEffectStr = function (jid, uid) {
            var jp = jiangpins[jid];
            var fj = tankes[uid];
            if (fj) {
                var rtstr = "0";
                if (jp.t == 0) {    //金币
                    fj.gold += jp.z;
                    rtstr = "0" + fj.id + String.fromCharCode(fj.gold);
                } else if (jp.t == 1) {    //加速
                    fj.v = dft_speed + dft_add_speed;
                    fj.v_t = new Date().getTime() + dfd_speed_t;
                    rtstr = "1" + fj.getMoveStr()
                } else if (jp.t == 2) { //加血
                    fj.h += 5;
                    fj.h > dfd_h ? fj.h = dfd_h : 0;
                    rtstr = "2" + fj.id;
                } else if (jp.t == 3) { //加枪
                    var guntype = JIANGPINS[jp.t].value;
                    var gunkey = fj.addGUN(guntype);
                    fj.setGUN(gunkey);
                    rtstr = "3" + fj.id + String.fromCharCode(gunkey);
                }
                JiangPin.remove(jid);
                return jid + rtstr;
            }
            return false;
        }
        JiangPin.loadEffectStr = function (str) {    //加载效果压缩字符串
            var jid = str[0];
            var t = str[1];
            var fjid = str[2];
            var fj = tankes[fjid];
            if (t == "0") {
                if (fj) {
                    fj.gold = str.charCodeAt(3);
                    if (game_env == 0 && my_id == fjid) {
                        gui_ud_gold();
                    }
                }
            } else if (t == "1") {
                var rst = str.substr(2);
                if (fj) {
                    fj.v_t = new Date().getTime() + dfd_speed_t;
                    Tank.loadMoveStr(rst);
                }
            } else if (t == "2") {
                if (fj) {
                    fj.h += 5;
                    fj.h > dfd_h ? fj.h = dfd_h : 0;
                    if (fjid == my_id) {
                        gui_ud_h();
                    }
                }
            } else if (t == "3") {
                var gunkey = str.charCodeAt(3);
                if (fj) {
                    fj.setGUN(gunkey);
                }
            }
            if (fj && game_env == 0 && !game_is_ai) {
                var jp = jiangpins[jid];
                if (jp) {
                    jp.chi = fj;    //被坦克吃掉，向坦克移动过去
                    jp.chi_ct = 1;
                }
            } else {
                JiangPin.remove(jid);
            }
            //console.log(t,jid.charCodeAt(0));
            //JiangPin.remove(jid);
        }
        JiangPin.getZipStr = function (jpid) {
            var jp = jiangpins[jpid];
            if (jp) {
                return jp.getZipStr();
            }
            return false;
        }
        JiangPin.loadZipStr = function (str) {
            var data = {
                id: str[0],
                x: str.charCodeAt(1) - 32768,
                y: str.charCodeAt(2) - 32768,
                t: str.charCodeAt(3) & 127,    //t
                r: str.charCodeAt(3) >> 7,    //r
                z: str.charCodeAt(4)
            };
            return JiangPin.add(data);
        }
        JiangPin.loadZipStrS = function (strs) {
            for (var i = 0; i < strs.length; i += 5) {
                JiangPin.loadZipStr(strs.substr(i, 5));
            }
        }
        JiangPin.tick = function (time) {
            var stime, jp, k, tk, sx, sy;
            for (var ji in jiangpins) {
                jp = jiangpins[ji];
                if (!jp.a) {
                    jp.remove();
                    continue;
                }
                if (jp.v != 0) {
                    stime = time - jp.m_t;
                    jp.x += jp.v_v.x * stime * jp.v * 0.01;
                    jp.y += jp.v_v.y * stime * jp.v * 0.01;
                    jp.m_t = time;
                }
                if (jp.chi) {
                    sx = (jp.chi.x - jp.x) * 0.05;
                    sy = (jp.chi.y - jp.y) * 0.05;
                    jp.x += sx;
                    jp.y += sy;
                    jp.chi_ct -= 0.05;
                    if (jp.chi_ct < 0.1) {
                        jp.a = false;
                    }
                } else if (jp.chi_ct < 1) {
                    jp.chi_ct += 0.05;
                }
                if (game_env == 2) {
                    if (jp.fj_tk) {
                        for (k = 0; k < jp.fj_tk.length; k++) {
                            tk = tankes[jp.fj_tk[k]];
                            if (!tk || !tk.a || tk.h <= 0) {
                                continue;
                            }
                            if (Math.abs(jp.x - tk.x) < tk_jp_juli && Math.abs(jp.y - tk.y) < tk_jp_juli) {   // + jp.rd
                                jp.a = false;
                                main.send("s" + jp.id + tk.id);
                                break;
                            }
                        }
                    }
                    //for (var fi in tankes) {
                    //    fj = tankes[fi];
                    //    if (fj.h <= 0 || !fj.a) {
                    //        continue;
                    //    }
                    //    if (Math.abs(jp.x - fj.x) < tk_jp_juli && Math.abs(jp.y - fj.y) < tk_jp_juli) {   // + jp.rd
                    //        jp.a = false;
                    //        main.send("s" + jp.id + fj.id);
                    //        break;
                    //    }
                    //}
                }
            }
        }
        JiangPin.a_tick = function (time) {
            var stime, jp;
            var juli = Infinity, zuijin = null, njuli;
            for (var ji in jiangpins) {
                jp = jiangpins[ji];
                if (!jp.a) {
                    jp.remove();
                    continue;
                }
                if (jp.v != 0) {
                    stime = time - jp.m_t;
                    jp.x += jp.v_v.x * stime * jp.v * 0.01;
                    jp.y += jp.v_v.y * stime * jp.v * 0.01;

                    jp.m_t = time;
                }
                njuli = Math.abs(jp.x - my_tank.x) + Math.abs(jp.y - my_tank.y);
                if (njuli < juli) {
                    zuijin = jp;
                    juli = njuli;
                }
            }
            ai_m_jiangpin = zuijin;
            ai_min_jp = juli;
        }

        function WuTi(data) {
            this.id = data.id || Math.floor(Math.random() * 100000) + "";   //id
            this.t = data.t || 0;   //物体的类型id
            this.x = data.x != undefined ? data.x : Math.random() * game_width * 2 - game_width; //x
            this.y = data.y != undefined ? data.y : Math.random() * game_height * 2 - game_height; //y
            this.r = data.r || 0;
            this.v_v = tools.deg2vector(this.r);    //移动方向的向量
            this.rd = data.radius || 10;   //半径
            this.v = data.v || 0;

            this.h = data.h || 5;
            this.mh = WUTIS[this.t].h;  //满血值
            this.a = true;
            this.b = true;  //辅助
            this.m_t = new Date().getTime();

            this.img = data.img || null;

            this.fj_tk = "";

            WuTi.remove(this.id);
            wutis[this.id] = this;
            this.add_fj();
        }
        WuTi.prototype.remove = function () {
            if (this.model) {
                this.model.destroy({ children: true });
            }
            delete wutis[this.id];
            if (game_env == 1) {
                wt_ids.free(this.id);
            }
        }
        WuTi.prototype.getZipStr = function () {
            //if (this.v==0 && this.zipstr)
            //    return this.zipstr
            var str = this.id +
            String.fromCharCode(Math.round(this.x) + 32768) +
            String.fromCharCode(Math.round(this.y) + 32768) +
            String.fromCharCode((this.r << 7) + this.t) +
            String.fromCharCode((this.h << 7) + this.rd);
            return this.zipstr = str;
        }
        WuTi.prototype.add_fj = function () {
            var tk, fj_ds = Tank.fj_dswj;
            for (var ti in tankes) {
                tk = tankes[ti];
                if (Math.abs(tk.x - this.x) < fj_ds && Math.abs(tk.y - this.y) < fj_ds) {
                    tk.fj_wt += this.id;
                    this.fj_tk += ti;
                }
            }
        }
        WuTi.add = function (data) {
            return new WuTi(data);
        }
        WuTi.random = function () {
            var num = Math.random();
            var suiji = WUTIS.suiji;
            var t = 0;
            for (var i = 0; i < suiji.length; i += 2) {
                if (num < suiji[i]) {
                    t = suiji[i + 1];
                    break;
                }
            }
            var data = {
                id: wt_ids.getOne(),
                t: t,
                h: WUTIS[t].h,
                radius: WUTIS[t].rd,
                img: WUTIS[t].img
            }
            return new WuTi(data);
        }
        WuTi.remove = function (wid) {
            var wt = wutis[wid];
            if (wt) {
                wt.remove();
            }
        }
        WuTi.clear = function () {
            for (var wi in wutis) {
                WuTi.remove(wi);
            }
        }
        WuTi.getZipStr = function (wid) {
            var wt = wutis[wid];
            if (wt) {
                return wt.getZipStr();
            }
            return "";
        }
        WuTi.loadZipStr = function (str) {
            var data = {
                id: str[0],
                x: str.charCodeAt(1) - 32768,
                y: str.charCodeAt(2) - 32768,
                t: str.charCodeAt(3) & 127,    //t
                r: str.charCodeAt(3) >> 7,    //r
                radius: str.charCodeAt(4) & 127,    //t
                h: str.charCodeAt(4) >> 7,    //r
            };
            data.img = WUTIS[data.t].img;

            return WuTi.add(data);
        }
        WuTi.loadZipStrS = function (strs) {
            for (var i = 0; i < strs.length; i += 5) {
                WuTi.loadZipStr(strs.substr(i, 5));
            }
        }
        WuTi.tick = function (now_time) {
            var wt;
            for (var wi in wutis) {
                wt = wutis[wi];
                if (!wt.a) {
                    wt.remove();
                    continue;
                }
            }
        }
        WuTi.tm = function (now_time) {
            var wt;
            for (var wi in wutis) {
                wt = wutis[wi];
                if (!wt.a) {
                    wt.remove();
                }
            }
        }
        WuTi.a_tick = function (now_time) {
            var wt;
            var juli = Infinity, zuijin = null,njuli;
            for (var wi in wutis) {
                wt = wutis[wi];
                if (!wt.a) {
                    wt.remove();
                    continue;
                }
                njuli = Math.abs(wt.x - my_tank.x) + Math.abs(wt.y - my_tank.y);
                if (njuli < juli) {
                    zuijin = wt;
                    juli = njuli;
                }
            }
            ai_m_wuti = zuijin;
            ai_min_wt = juli;
        }


        function Zidan(data) {
            this.fid = data.fid || 0; //发射着的id
            this.x = data.x || 0;
            this.y = data.y || 0;
            this.r = data.r || 0;   //方向
            this.k = data.k || 1;   //伤害值
            this.v = data.v || 0;   //子弹的速度
            this.a = true    //is active
            this.t = data.t || 1000; //持续时间
            this.s_t = data.s_t || new Date().getTime() //发射时间
            this.m_t = this.s_t //上一次移動的時間
            this.v_v = tools.deg2vector(this.r);   //速度的基础向量
            this.img = data.img || 0; //

            this.fj_tk = data.fj_tk || false;
            this.fj_wt = data.fj_wt || false;
            if (this.fj_wt) {
                this.fj_wt_d = new Array(this.fj_wt.length);
            }

            zidans.push(this);
        }
        Zidan.prototype.remove = function () {
            if (this.model) {
                this.model.destroy({ children: true });
            }
        }
        Zidan.add = function (data) {
            return new Zidan(data);
        }
        Zidan.tick = function (time) {
            var i = 0, zd, stime, fj, wt, tk;
            for (; i < zidans.length; i++) {
                zd = zidans[i];
                stime = time - zd.s_t;
                if (stime > zd.t || !zd.a) {
                    zd.remove();
                    zidans.splice(i, 1);
                    i--;
                    continue;
                }
                stime = time - zd.m_t;
                zd.x += zd.v_v.x * stime * zd.v * 0.01;
                zd.y += zd.v_v.y * stime * zd.v * 0.01;
                zd.m_t = time;
            }


            if (game_env == 0) {    //客户端
                for (i = 0; i < zidans.length; i++) {
                    zd = zidans[i];
                    if (!zd.a) {
                        continue;
                    }
                    for (var fi in tankes) {
                        fj = tankes[fi];
                        if (fj.h <= 0 || fi == zd.fid) {
                            continue;
                        }
                        if (Math.abs(zd.x - fj.x) < tk_juli && Math.abs(zd.y - fj.y) < tk_juli) {
                            zd.a = false;
                            //fj.h -= 1;
                            //fj.h < 0 ? fj.h = 0 : 0;
                            break;
                        }
                    }
                    if (!zd.a) {
                        continue;
                    }
                    for (var wi in wutis) {
                        wt = wutis[wi];
                        if (wt.h <= 0) {
                            continue;
                        }
                        if (Math.max(Math.abs(zd.x - wt.x), Math.abs(zd.y - wt.y)) < wt.rd) {
                            zd.a = false;
                            break;
                        }
                    }
                }
            }
            if (game_env == 2) {    //裁判端
                var k,d,wid;
                for (i = 0; i < zidans.length; i++) {
                    zd = zidans[i];
                    if (!zd.a) {
                        continue;
                    }

                    if (zd.fj_tk) {
                        for (k = 0; k < zd.fj_tk.length; k++) {
                            tk = tankes[zd.fj_tk[k]];
                            if (!tk || tk.h <= 0) {
                                continue;
                            }
                            if (Math.abs(zd.x - tk.x) < tk_juli && Math.abs(zd.y - tk.y) < tk_juli) {
                                zd.a = false;
                                tk.h -= zd.k;
                                if (tk.h <= 0) {
                                    main.send("k" + zd.fid + tk.id);
                                    tk.a = false;
                                    if (tankes[zd.fid]) {
                                        tankes[zd.fid].kill++;
                                    }
                                } else {
                                    main.send("j" + zd.fid + tk.id + String.fromCharCode(tk.h));
                                }
                                break;
                            }
                        }
                    }

                    //for (var ti in tankes) {
                    //    fj = tankes[ti];
                    //    if (fj.h <= 0 || ti == zd.fid) {
                    //        continue;
                    //    }
                    //    if (Math.abs(zd.x - fj.x) < tk_juli && Math.abs(zd.y - fj.y) < tk_juli) {
                    //        zd.a = false;
                    //        fj.h -= zd.k;
                    //        if (fj.h <= 0 ) {
                    //            main.send("k" + zd.fid + fj.id);
                    //            fj.a = false;
                    //            if (tankes[zd.fid]) {
                    //                tankes[zd.fid].kill++;
                    //            }
                    //        } else {
                    //            main.send("j" + zd.fid + fj.id + String.fromCharCode(fj.h));
                    //        }
                    //        break;
                    //        //fj.h < 0 ? fj.h = 0 : 0;
                    //    }
                    //}
                    if (!zd.a) {
                        continue;
                    }
                    if (zd.fj_wt) {
                        for (k = 0; k < zd.fj_wt.length; k++) {
                            wid = zd.fj_wt[k];
                            wt = wutis[wid];
                            if (!wt || !wt.a || wt.h <= 0) {
                                zd.fj_wt.replace(wid, "");
                                zd.fj_wt_d.splice(k, 1);
                                continue;
                            }
                            d = Math.max(Math.abs(zd.x - wt.x), Math.abs(zd.y - wt.y))
                            if (d < wt.rd) {
                                zd.a = false;
                                wt.h -= zd.k;
                                if (wt.h <= 0) {
                                    main.send("i" + zd.fid + wt.id);
                                    wt.a = false;
                                } else {
                                    main.send("h" + zd.fid + wt.id + String.fromCharCode(wt.h));
                                }
                                break;
                            } else if (zd.fj_wt_d[k] == undefined) {
                                zd.fj_wt_d[k] = d;
                            } else if (zd.fj_wt_d[k] != undefined) {
                                if (d > zd.fj_wt_d[k]) {
                                    zd.fj_wt.replace(wid, "");
                                    zd.fj_wt_d.splice(k, 1);
                                } else {
                                    zd.fj_wt_d[k] = d;
                                }
                            }
                            
                        }
                    }
                    //console.log("============")
                    //for (var wi in wutis) {
                    //    wt = wutis[wi];
                    //    if (wt.h <= 0) {
                    //        continue;
                    //    }
                    //    if (Math.max(Math.abs(zd.x - wt.x), Math.abs(zd.y - wt.y)) < wt.rd) {
                    //        zd.a = false;

                    //        wt.h -= zd.k;
                    //        if (wt.h <= 0) {
                    //            main.send("i" + zd.fid + wt.id);
                    //            wt.a = false;
                    //        } else {
                    //            main.send("h" + zd.fid + wt.id + String.fromCharCode(wt.h));
                    //        }

                    //        break;
                    //    }
                    //}
                }
            }
        }


        function Tank(data) {
            this.id = data.id || Math.floor(Math.random() * 100000) + "";   //id
            this.n = data.n || (game_env==1?"nameless":null);    //名字
            this.x = data.x != undefined ? data.x : Math.random() * game_width * 2 - game_width; //x
            this.y = data.y != undefined ? data.y : Math.random() * game_width * 2 - game_width; //y
            this.r = data.r || 0;   //移动方向 0表示不移动
            this.c_r = this.r+1;  //过渡r
            this.v_v = tools.deg2vector(this.r);    //移动方向的向量
            this.m_t = new Date().getTime();  //移动时间
            this.mt_pst = {x:0,y:0};    //途经点模式的目标坐标
            this.mt_t = 0;           //途径点模式的到达目标时间

            this.p = data.p!=undefined?data.p : 0;   //炮口方向
            this.c_p = this.p+1;  //model的炮口方向过渡
            this.v_p = tools.deg2vector(this.p);    //坦克的炮塔方向的向量 主要用于向量和
            this.v = data.v || dft_speed;   //速度       0-63;
            this.v_t = data.v_t || 0;       //加速效果的结束时间
            this.h = data.h || dfd_h;
            this.a = data.a || true;

            this.gun = data.gun || 0;   //枪的种类
            this.wp = null,   //武器weapon
            this.f = data.f||false;    //开火状态
            this.f_t = data.f_t || 0;  //设置开火时间


            this.s_v = 0;   //移动速度加点
            this.s_h = 0;   //生命值加点
            this.s_k = 0;   //伤害值加点
            this.s_p = 0;   //射击速度加点
            this.s_j = 0;   //射击距离加点

            this.lv = 0;    //等级
            this.score = 0; //分数
            this.kill = 0;  //杀敌
            this.gold = 0;  //金币

            this.skin = 0;

            this.fj_tk = "";
            this.fj_wt = "";
            this.fj_jp = "";

            this.setR(this.r);

            Tank.remove(this.id);
            tankes[this.id] = this;
            if (this.id == my_id) {
                my_tank = this;
                this.n = pageData.userName;
            }
        }
        Tank.prototype.setR = function (r) {    //设置自己的方向
            this.r = r;
            if (r == 0) {
                this.v_v.x = this.v_v.y = 0;
            }else
                tools.deg2vector(this.r, this.v_v);
        }
        Tank.prototype.setP = function (p) {    //设置自己的炮口方向
            this.p = p;
            tools.deg2vector(this.p, this.v_p);
        }
        Tank.prototype.addGUN = function (gunstr) { //拾取枪的时候，计算下一把是啥枪
            var gid = this.gun;
            var gunobj = GUNS[gid];
            if (gunobj.code == gunstr) {
                return gunobj.next;
            } else {
                var k = gunobj[gunstr]
                if (gunobj[k]) {
                    return k;
                }
            }
            return this.gun;
        }
        Tank.prototype.setGUN = function (guncode) {    //设置自己的gun
            if (this.gun != guncode) {
                this.wp = null;
                this.gun = guncode;
                if (this.paota) {
                    this.paota.destroy({ children: true });
                    this.paota = null;
                }
            }
        }
        Tank.prototype.setF = function (f) {
            if (f) {
                //this.f_t = 0;
                if (this.wp) {
                    var fsf = this.wp.fires[0];
                    var fsn;
                    var time = new Date().getTime();
                    if (fsf) {
                        if (time > fsf.f_t) {
                            fsf.f_t = time + fsf.st;
                            for (var fi = 1; fi < this.wp.fires.length; fi++) {
                                fsn = this.wp.fires[fi];
                                fsn.f_t = time + fsn.st;
                            }
                        }
                    }
                }
            }
            this.f = f;
        }
        Tank.prototype.setGold = function (gold) {
            this.gold = gold;
            if (game_env == 0 && my_id == this.id) {
                gui_ud_gold();
            }
        }
        Tank.move_once_time = 2000;   //一次移动信息对应的时间
        Tank.prototype.move_once_time = Tank.move_once_time;   //一次移动信息对应的时间
        Tank.prototype.getMoveStr = function (r) {
            if (r !== undefined) {
                if (r == 0) {
                    if (game_env == 1) {
                        this.r = r;
                    }
                    this.v_v.x = this.v_v.y = 0;
                } else {
                    this.r = r;
                    tools.deg2vector(this.r, this.v_v);
                }
            }
            this.mt_t = new Date().getTime() + Tank.move_once_time;
            return this.id +
                String.fromCharCode(Math.round(this.x) + 32768) +
                String.fromCharCode(Math.round(this.y) + 32768) +
                String.fromCharCode((this.r << 6) + this.v);
        }
        Tank.prototype.getZipStr = function () {
            var str = this.id +
                String.fromCharCode(Math.round(this.x) + 32768) +
                String.fromCharCode(Math.round(this.y) + 32768) +
                String.fromCharCode((this.r<<6) + this.v) +
                String.fromCharCode(Math.floor(this.p)) +
                String.fromCharCode(Math.floor(this.h)) +
                String.fromCharCode((this.gun << 1) + (this.f ? 1 : 0));  //用gun id 左移一位判断开火状态
            return str;
        }
        Tank.prototype.remove = function () {
            if (this.model) {
                this.model.destroy({ children: true });
            }
            delete tankes[this.id];
            if (game_env == 1) {
                ids.free(this.id);
            }
        }
        Tank.prototype.add_fj = function () {   //算出附近的信息
            var tk, fj_ds = Tank.fj_ds;
            var wt, jp;
            for (var ti in tankes) {
                tk = tankes[ti];
                if (Math.abs(tk.x - this.x) < fj_ds && Math.abs(tk.y - this.y) < fj_ds && ti != this.id) {
                    tk.fj_tk += this.id;
                    this.fj_tk += ti;
                }
            }
            fj_ds = Tank.fj_dswj;
            for (var wi in wutis) {
                wt = wutis[wi];
                if (Math.abs(tk.x - wt.x) < fj_ds && Math.abs(tk.y - wt.y) < fj_ds) {
                    wt.fj_tk += this.id;
                    tk.fj_wt += wi;
                }
            }
            for (var ji in jiangpins) {
                jp = jiangpins[ji];
                if (Math.abs(tk.x - jp.x) < fj_ds && Math.abs(tk.y - jp.y) < fj_ds) {
                    jp.fj_tk += this.id;
                    tk.fj_jp += ji;
                }
            }
        }
        Tank.add = function (data) {
            return new Tank(data);
        }
        Tank.getMoveStr = function (tkid, r) {
            var tk = tankes[tkid];
            if (tk) {
                return tk.getMoveStr(r);
            }
            return null;
        }
        Tank.loadMoveStr = function (str) {
            var id = str[0];
            var x = str.charCodeAt(1) - 32768;    //x
            var y = str.charCodeAt(2) - 32768;    //y
            var r = str.charCodeAt(3);    //r
            var v = r & 63;    //v
            r = r >> 6;


            var tk = tankes[id];
            if (tk) {
                tk.v = v;
                if (r == 0) {
                    tk.v_v.x = tk.v_v.y = 0;
                    tk.mt_pst.x = x;
                    tk.mt_pst.y = y;
                } else {
                    tk.r = r;
                    tools.deg2vector(tk.r, tk.v_v);
                    tk.mt_pst.x = x + tk.v_v.x * Tank.move_once_time * tk.v * 0.01;
                    tk.mt_pst.y = y + tk.v_v.y * Tank.move_once_time * tk.v * 0.01;
                }
                tk.mt_t = new Date().getTime() + Tank.move_once_time;
                return tk;
            }
            return false;
        }
        Tank.getZipStr = function (id) {
            var tk = tankes[id];
            if (tk) {
                return tk.getZipStr();
            }
            return "";
        }
        Tank.loadZipStr = function (str) {
            var data = {
                id: str[0],
                x: str.charCodeAt(1) - 32768,
                y: str.charCodeAt(2) - 32768,
                r: str.charCodeAt(3),
                p: str.charCodeAt(4),
                h: str.charCodeAt(5),
                f: !!(str.charCodeAt(6) & 1),
                gun: str.charCodeAt(6) >> 1
            }
            data.v = data.r & 63;
            data.r = data.r >> 6;
            if (game_env == 0) {
                setTimeout(function () {
                    if(tankes[data.id])
                        socket.emit("n", data.id);
                },1000)
            }
            //if (game_env == 2) {
            //    main.send("n" + data.id);
            //}
            var tk = Tank.add(data);
            if (game_env == 2) {
                tk.add_fj();
            }
        }
        Tank.loadZipStrS = function (strs) {
            for (var i = 0; i < strs.length; i += 8) {
                Tank.loadZipStr(strs.substr(i, 7));
            }
        }
        Tank.remove = function (tkid) {
            var tk = tankes[tkid];
            if (tk) {
                tk.remove();
            }
        }
        Tank.clear = function () {
            for (var ti in tankes) {
                tankes[ti].remove();
            }
        }
        Tank.setGUN = function (tkid, guncode) {
            var tk = tankes[tkid];
            if (tk) {
                tk.setGUN(guncode);
            }
        }
        Tank.imove = (function(){
            var sending_r = 0;
            var issending_r = false;
            return function (r) {  //移动方向
                r = Math.round(r)
                if (sending_r != r) {
                    sending_r = r;
                    if (!issending_r) {
                        issending_r = true;
                        setTimeout(function () {
                            socket.emit("r", String.fromCharCode(sending_r));
                            issending_r = false;
                        }, 60);
                    }
                }
            }
        })();
        Tank.ipao = (function(){
            var sending_p = 0;
            var issending_p = false;
            return function (p) {   //炮口方向
                p = Math.round(p)
                if (sending_p != p) {
                    sending_p = p;
                    if (!issending_p) {
                        issending_p = true;
                        setTimeout(function () {
                            socket.emit("p", String.fromCharCode(sending_p));
                            issending_p = false;
                        }, 130);
                    }
                }
            }
        })();
        Tank.setFireState = function (tkid, f) {
            var tk = tankes[tkid];
            if (tk) {
                tk.setF(f);
            }
        }
        Tank.ibg = function (id) {
            id -= 0;
            var gstr = String.fromCharCode(id);
            socket.emit("d", gstr);
        };
        Tank.ifire = (function () {
            var sending_f = false;
            return function (isfire) {
                if (isfire != sending_f) {
                    sending_f = isfire;
                    if (sending_f) {
                        socket.emit("f", "");
                    } else {
                        socket.emit("e", "");
                    }
                    //socket.emit("f", sending_f ? String.fromCharCode(1) : String.fromCharCode(0));
                }
            }
        })();
        Tank.tickFire = function (time) {
            var tk, i, fires, fri, fx, fy,fc;
            for (var ti in tankes) {
                tk = tankes[ti];
                if (tk.h <= 0 || !tk.f) {
                    continue;
                }
                if (!tk.wp) {
                    tk.wp = tools.clone(GUNS[tk.gun]);
                    for (var fi = 0; fi < tk.wp.fires.length; fi++) {
                        fri = tk.wp.fires[fi];
                        fri.f_t = time + fri.st;
                    }

                    //tk.wp.count = -1;    //开火计量
                }
                
                for (var fi in tk.wp.fires) {
                    fc = tk.wp.fires[fi];
                    if (time >= fc.f_t) {
                        fc.f_t = time - ((time - fc.f_t) % fc.tt) + fc.tt;
                        
                        if (fc.fr != tk.p) {
                            fc.fr = tk.p;
                            fc.fx = fc.tx * tk.v_p.x - fc.ty * tk.v_p.y;
                            fc.fy = fc.tx * tk.v_p.y + fc.ty * tk.v_p.x;
                        }

                        fx = fc.fx + tk.x;
                        fy = fc.fy + tk.y;

                        if (game_env == 0) {
                            Zidan.add({
                                fid: tk.id,
                                x: fx,
                                y: fy,
                                r: tk.p + fc.tr,
                                k: fc.k || 1,
                                t: fc.ct || 1000, //持续时间
                                v: fc.v || 40,
                                s_t: time,
                                img: fc.img || "zd0"
                            });
                        }

                        if (game_env == 2) {
                            Zidan.add({
                                fid: tk.id,
                                x: fx,
                                y: fy,
                                r: tk.p + fc.tr,
                                k: fc.k || 1,
                                t: fc.ct || 1000, //持续时间
                                v: fc.v || 40,
                                s_t: time,
                                fj_tk: tk.fj_tk,
                                fj_wt: tk.fj_wt,
                            });
                        }


                    }



                }

                //if (time >= tk.f_t) {
                //    //if (tk.f_t > 0) {
                //    //    tk.f_t = time - ((time - tk.f_t) % tk.wp.tt) + tk.wp.tt;
                //    //} else {
                //        //tk.f_t = time + tk.wp.tt;
                //    //}
                //    tk.f_t = time - ((time - tk.f_t) % tk.wp.tt) + tk.wp.tt;
                //    fires = tk.wp.fires;
                //    for (i = 0; i < fires.length; i++) {
                //        fri = fires[i]  //火力点
                //        if (fri.fr != tk.p) {
                //            fri.fr = tk.p;
                //            fri.fx = fri.tx * tk.v_p.x - fri.ty * tk.v_p.y;
                //            fri.fy = fri.tx * tk.v_p.y + fri.ty * tk.v_p.x;
                //        }
                //        //此处可进行缓冲优化
                //        fx = fri.fx + tk.x;
                //        fy = fri.fy + tk.y;
                //        if (game_env == 0) {
                //            Zidan.add({
                //                fid: tk.id,
                //                x: fx,
                //                y: fy,
                //                r: tk.p + fri.tr,
                //                k: fri.k || tk.wp.k || 1,
                //                t: fri.ct || tk.wp.ct || 1000, //持续时间
                //                v: fri.v || tk.wp.v,
                //                s_t: time,
                //                img: fri.img || tk.wp.img
                //            });
                //        }
                //        if (game_env == 2) {
                //            Zidan.add({
                //                fid: tk.id,
                //                x: fx,
                //                y: fy,
                //                r: tk.p + fri.tr,
                //                k: fri.k || tk.wp.k || 1,
                //                t: fri.ct || tk.wp.ct || 1000, //持续时间
                //                v: fri.v || tk.wp.v,
                //                s_t: time,
                //                img: fri.img || tk.wp.img,
                //                fj_tk: tk.fj_tk,
                //                fj_wt: tk.fj_wt,
                //            });
                //        }
                //    }
                //}

            }
        }
        Tank.tickMove = function (now_time) {
            var stime, tk, fx, fy;
            var width = game_width + 100;
            var height = game_height + 100;
            for (var ti in tankes) {
                tk = tankes[ti];
                if (!tk.a) {
                    tk.remove();
                    continue;
                }
                if (tk.mt_t > tk.m_t) {
                    stime = tk.mt_t - tk.m_t;
                    fx = tk.mt_pst.x - tk.v_v.x * stime * tk.v * 0.01;
                    fy = tk.mt_pst.y - tk.v_v.y * stime * tk.v * 0.01;
                    tk.x += (fx - tk.x) / 5;
                    tk.y += (fy - tk.y) / 5;
                } else {
                    stime = now_time - tk.m_t;
                    tk.x += tk.v_v.x * stime * tk.v * 0.01;
                    tk.y += tk.v_v.y * stime * tk.v * 0.01;
                    if (game_env == 0 && tk.mt_t != 0 && tk.mt_t - tk.m_t < -3000 && tk.h > 0) {
                        tk.remove();
                    }
                }
                tk.m_t = now_time;

                if (game_env == 0) {
                    if (ti == my_id && my_tank != tk) {
                        my_tank = tk;
                        tk.n = pageData.userName;
                    }

                }
                if (game_env == 2) {
                    if (tk.x > width || tk.x < -width || tk.y > height || tk.y < -height) {
                        main.send("k" + tk.id + tk.id);
                        tk.a = false;
                    }
                }
            }

        }
        Tank.tickMainMove = function (now_time) {
            var stime, tk;
            for (var ti in tankes) {
                tk = tankes[ti];
                if (!tk.a) {
                    tk.remove();
                    continue;
                }
                stime = now_time - tk.m_t;
                if (tk.r != 0) {
                    tk.x += tk.v_v.x * stime * tk.v * 0.01;
                    tk.y += tk.v_v.y * stime * tk.v * 0.01;
                }
                tk.m_t = now_time;
            }
        }
        Tank.tickAI = function (time) {
        }
        Tank.a_tick = function (now_time) {
            var stime, tk, fx, fy;
            //var width = game_width + 100;
            //var height = game_height + 100;
            var juli = Infinity, zuijin = null, njuli;
            for (var ti in tankes) {
                tk = tankes[ti];
                if (!tk.a) {
                    tk.remove();
                    continue;
                }
                if (tk.mt_t > tk.m_t) {
                    stime = tk.mt_t - tk.m_t;
                    fx = tk.mt_pst.x - tk.v_v.x * stime * tk.v * 0.01;
                    fy = tk.mt_pst.y - tk.v_v.y * stime * tk.v * 0.01;
                    tk.x += (fx - tk.x) / 5;
                    tk.y += (fy - tk.y) / 5;
                } else {
                    stime = now_time - tk.m_t;
                    tk.x += tk.v_v.x * stime * tk.v * 0.01;
                    tk.y += tk.v_v.y * stime * tk.v * 0.01;
                    if (game_env == 0 && tk.mt_t != 0 && tk.mt_t - tk.m_t < -3000 && tk.h > 0) {
                        tk.remove();
                    }
                }
                tk.m_t = now_time;

                if (ti == my_id && my_tank != tk) {
                    my_tank = tk;
                }

                if (ti != my_id) {
                    njuli = Math.abs(tk.x - my_tank.x) + Math.abs(tk.y - my_tank.y);
                    if (njuli < juli) {
                        zuijin = tk;
                        juli = njuli;
                    }
                }
            }
            ai_m_tank = zuijin;
            ai_min_tk = juli;
        }
        Tank.fj_ds = 1200;
        Tank.fj_dswj = 800;
        Tank.tick_fj = function () {
            var tk, tk2, tkeys,fj_ds = Tank.fj_ds;
            tkeys = Object.keys(tankes);
            var t_1 = tkeys.length - 1;
            for (var ti in tankes) {
                tk = tankes[ti];
                tk.fj_tk = "";
                tk.fj_wt = "";
                tk.fj_jp = "";
            }
            for (var i = 0; i < t_1; i++) {
                tk = tankes[tkeys[i]];
                for (var j = i + 1; j < tkeys.length; j++) {
                    tk2 = tankes[tkeys[j]];
                    if (Math.abs(tk.x - tk2.x) < fj_ds && Math.abs(tk.y - tk2.y) < fj_ds) {
                        tk.fj_tk += tkeys[j];
                        tk2.fj_tk += tkeys[i];
                    }
                }
            }
            fj_ds = Tank.fj_dswj;
            var wt;
            for (var wi in wutis) {
                wt = wutis[wi];
                wt.fj_tk = "";
                for (var ti in tankes) {
                    tk = tankes[ti];
                    if (Math.abs(tk.x - wt.x) < fj_ds && Math.abs(tk.y - wt.y) < fj_ds) {
                        wt.fj_tk += ti;
                        tk.fj_wt += wi;
                    }
                }
            }
            var jp;
            for (var ji in jiangpins) {
                jp = jiangpins[ji];
                jp.fj_tk = "";
                for (var ti in tankes) {
                    tk = tankes[ti];
                    if (Math.abs(tk.x - jp.x) < fj_ds && Math.abs(tk.y - jp.y) < fj_ds) {
                        jp.fj_tk += ti;
                        tk.fj_jp += ji;
                    }
                }
            }
        }
        Tank.tick_fj_t = function () {

        }


        function tick() {
            var now_time = new Date().getTime();
            Tank.tickMove(now_time);
            JiangPin.tick(now_time);
            WuTi.tick(now_time);
            Zidan.tick(now_time);
            Tank.tickFire(now_time);
            Tank.tickAI(now_time);
            if (fj_time != 0 && now_time - fj_time > 1000) {
                socket.emit("C","");
                fj_time = now_time;
            }
        }

        function main_tick(now_time) {
            Tank.tickMainMove(now_time);
            WuTi.tm(now_time);
            //Tank.tick_fj();
        }
        function referee_tick(now_time) {
            Tank.tickMove(now_time);
            JiangPin.tick(now_time);
            WuTi.tick(now_time);
            Zidan.tick(now_time);
            Tank.tickFire(now_time);
        }


        function serverMessage(data) {
            if (serverEvent[data[0]]) {
                serverEvent[data[0]](data.substr(1));
            }
        }
        var serverEvent = {
            a: function () {    //服务器发过来的准备通知
                socket.emit("a", pageData.userName);
            },
            b: function (data) {    //收到id，设置自己的id
                my_id = data;
                ws_game_open();
                socket.emit("g", "");
                socket.emit("w", "");
            },
            c: function (data) {    //收到服务器发送过来的飞机信息
                Tank.loadZipStrS(data);
            },
            d: function (data) {       //收到服务器用户断开连接的信息
                Tank.remove(data);
            },
            e: function (data) {       //关火指令
                Tank.setFireState(data, false);
            },
            f: function(data){      //开火指令
                Tank.setFireState(data, true);
            },
            g:function(data){   //服务器发送过来的战利品信息
                JiangPin.loadZipStrS(data);
            },
            h: function (data) {    //击中物品
                if (game_env == 0) {
                    var wid = data[1];
                    var h = data.charCodeAt(2);
                    var wt = wutis[wid]
                    if (wt) {
                        wt.h = h;
                    }
                }
            },
            i: function (data) {    //击杀物品
                if (game_env == 0) {
                    var wid = data[1];
                    var wt = wutis[wid]
                    if (wt) {
                        wt.h = 0;
                        wt.a = false;
                    }
                }
            },
            j: function (data) {    //击中
                if (game_env == 0) {
                    var fid = data[1];
                    var h = data.charCodeAt(2);
                    var fj = tankes[fid]
                    if (fj) {
                        fj.h = h;
                        if (game_env == 0 && fid == my_id) {
                            gui_ud_h();
                        }
                    }
                }
            },
            k: function (data) {    //击杀
                if (game_env == 0) {
                    var yid = data[0];
                    var fid = data[1];
                    var kname;
                    var fj = tankes[fid];
                    
                    if (fj) {
                        fj.h = 0;
                        kname = fj.n || "player:" + fid.charCodeAt(0);
                    } else {
                        kname = "player:" + fid.charCodeAt(0);
                    }
                    if (yid == my_id) {
                        gui_show_kill("YOU", kname);
                        my_tank.kill++;
                    }
                    if (game_env == 0 && fid == my_id) {
                        gui_ud_h();
                    }
                }
            },
            m: function (data) {    //移动指令
                var fj = tankes[data.substr(0, 1)];
                if (fj) {
                    Tank.loadMoveStr(data);
                } else {
                    if (game_env === 0) {
                        var id = data.substr(0, 1)
                        socket.emit("c", id);
                    }
                }
            },
            n: function (data) {       //服务器返回的用户名称
                var id = data[0];
                var name = data.substr(1);
                if (tankes[id]) {
                    tankes[id].n = name;
                }
            },
            p: function (data) {    //服务器发送过来的用户的炮口方向信息
                var fj = tankes[data[0]];
                if (fj) {
                    fj.setP(data.charCodeAt(1))
                }
            },
            r: function (data) {    //转向指令  暂时弃用
                var fj = tankes[data[0]];
                if (fj) {
                    fj.setR(data.charCodeAt(1))
                } else {
                    if (game_env === 0)
                        socket.emit("c", data.substr(0, 1));
                }
            },
            s: function (data) {    //捡到物品
                JiangPin.loadEffectStr(data);
            },
            t: function (data) {
                var tid = data[0];
                var gid = data.charCodeAt(1);
                var gold = data.charCodeAt(2);
                var tk = tankes[tid]
                if (tk) {
                    tk.setGUN(gid);
                    tk.setGold(gold);
                }

            },
            w: function (data) {   //服务器发送过来的物品信息
                WuTi.loadZipStrS(data);
            },
            x: function (data) {    //设置自己的名次
                if (game_env == 0) {
                    my_tank.idx = data.charCodeAt(0);
                }
            },
            y: function (data) {    //设置排行榜
                if (game_env == 0) {
                    gui_ud_rank(data);
                }
            },
            C:function(data){
                var len = data.charCodeAt(0);
                var wts = data.substr(1, len);
                var jps = data.substr(len + 1);
                my_tank.fj_wt = wts;
                my_tank.fj_jp = jps;

                var wt, jp, nwt = "", njp = "";
                for (var ti in wutis) {
                    wt = wutis[ti];
                    wt.b = false;
                }
                for (var i = 0; i < wts.length; i++) {
                    wt = wutis[wts[i]];
                    if (wt) {
                        wt.b = true;
                    } else {
                        nwt += wts[i];
                    }
                }
                for (var ti in wutis) {
                    wt = wutis[ti];
                    if(!wt.b)
                        wt.a = false;
                }

                for (var ji in jiangpins) {
                    jp = jiangpins[ji];
                    jp.b = false;
                }
                for (var i = 0; i < jps.length; i++) {
                    jp = jiangpins[jps[i]];
                    if (jp) {
                        jp.b = true;
                    } else {
                        njp += jps[i];
                    }
                }
                for (var ji in jiangpins) {
                    jp = jiangpins[ji];
                    if (!jp.b&&!jp.chi)
                        jp.a = false;
                }
                //console.log(wts.length, jps.length,nwt.length,njp.length);

                var str = String.fromCharCode(nwt.length) + nwt;
                str += njp;
                if (str.length > 1) {
                    socket.emit("D", str);
                }
            },
            D: function (data) {
                var len = data.charCodeAt(0);
                var wts = data.substr(1, len);
                var jps = data.substr(len + 1);
                WuTi.loadZipStrS(wts);
                JiangPin.loadZipStrS(jps);
            }
        }

        //endcopycode

        var renderer, stage, scene;
        var w = 900, h = 900,
            w_w = w, w_h = h,   //window 的实际宽高
            haf_w, haf_h;
        var presskeys = {};
        (function () {
            //var dorw_texture = null;
            function loadImages() {
                for (ti in textures) {
                    textures[ti] = PIXI.Texture.fromImage(textures[ti]);
                }

                //var cvs = document.createElement("canvas");
                //var ctx = cvs.getContext("2d");

            } loadImages();

            var canvas_div = document.getElementById("js-canvas-cont");
            renderer = PIXI.autoDetectRenderer(w, h, { transparent: true  });//backgroundColor: 0x1099bb

            canvas_div.appendChild(renderer.view);
            stage = new PIXI.Container();
            scene = new PIXI.Container();


            var texture = PIXI.Texture.fromImage(texture_bg);
            var tilingSprite = new PIXI.extras.TilingSprite(texture, w, h);
            //tilingSprite.anchor.set(0.5, 0.5);
            

            var bindthing = new PIXI.Graphics();

            scene.addChild(tilingSprite);
            scene.addChild(stage);
            scene.addChild(bindthing);

            var basething = new PIXI.Graphics(); // 地图
            var objs = new PIXI.Graphics(); //画些标志的东西  生命条等物件
            stage.addChild(basething);
            stage.addChild(objs);

            var jiangpincont = new PIXI.Container();
            stage.addChild(jiangpincont);

            var wuticont = new PIXI.Container();
            stage.addChild(wuticont);

            var tankecont = new PIXI.Container();
            stage.addChild(tankecont);

            var zidancont = new PIXI.Container();
            stage.addChild(zidancont);

            //绘制基本的边界线框
            function rebase() {
                basething.clear();
                basething.lineStyle(6, 0xff0000, 0.3);
                basething.drawRect(-game_width, -game_height, game_width << 1, game_height << 1);

                basething.lineStyle(1, 0xff0000, 0.3);
                //basething.drawCircle(0, 0, 50);
                //basething.beginFill(0xff0000,0.1);
                //basething.drawCircle(0, 0, 10);
                //basething.endFill();
            }

            //function inView(obj) {



            //}

            window.requestAnimationFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame;
            //更新场景中的基础显示对象
            var updateBG = (function () {

                var map_width = 80, map_height;
                var map_scale = map_width / game_width;
                map_height = game_height * map_scale;
                base_x = map_width + 0;    //w - map_width - 10
                base_y = map_height + 0;   //h - map_height - 10

                var tk,wt,jp;

                return function () {
                    if (my_tank) {
                        tilingSprite.tilePosition.x = Math.round(-my_tank.x) + haf_w;
                        tilingSprite.tilePosition.y = Math.round(-my_tank.y) + haf_h;
                    }

                    //画地图
                    

                    bindthing.clear();
                    //bindthing.lineStyle(0, 0x666666, 0.3);
                    bindthing.beginFill(0x000000, 0.5);
                    bindthing.drawRect(-map_width + base_x, -map_height + base_y, map_width << 1, map_height << 1);
                    bindthing.endFill();
                    bindthing.lineStyle(1, 0x666666, 0.1);
                    bindthing.beginFill(0x000000, 0.5);
                    bindthing.drawCircle( base_x, base_y, map_width-10);
                    bindthing.endFill();
                    //bindthing.lineStyle(2, 0xffffff, 0.3);
                    //bindthing.moveTo(base_x, base_y - map_height + 10).lineTo(base_x, base_y + map_height - 10);
                    //bindthing.moveTo(base_x - map_width, base_y).lineTo(base_x + map_width, base_y);


                    //敌军
                    bindthing.lineStyle(1, 0xff0000, 0.4);
                    bindthing.beginFill(0xff3333, 0.6);
                    for (var ti in tankes) {
                        tk = tankes[ti];
                        bindthing.drawCircle(tk.x * map_scale + base_x, tk.y * map_scale + base_y, 2)
                    }
                    bindthing.endFill();

                    //物品
                    bindthing.lineStyle(0, 0xff00ff, 0.2);
                    bindthing.beginFill(0xff9933, 0.6);
                    for (var wi in wutis) {
                        wt = wutis[wi];
                        bindthing.drawCircle(wt.x * map_scale + base_x, wt.y * map_scale + base_y, 1)
                    }
                    bindthing.endFill();

                    //物品
                    bindthing.beginFill(0x3399ff, 0.6);
                    for (var wi in jiangpins) {
                        wt = jiangpins[wi];
                        bindthing.drawCircle(wt.x * map_scale + base_x, wt.y * map_scale + base_y, 1)
                    }
                    bindthing.endFill();

                    //自己
                    bindthing.lineStyle(1, 0x00ff00, 0.4);
                    bindthing.beginFill(0x00ff33, 0.6);
                    bindthing.drawCircle(my_tank.x * map_scale + base_x, my_tank.y * map_scale + base_y, 3)
                    bindthing.endFill();
                }
            })();

            //更新场景中的显示对象
            function updateObjShow(now_time) {
                var fj, zd,gs,wt;
                var minx = my_tank.x - haf_w, maxx = my_tank.x + haf_w,
                    miny = my_tank.y - haf_h, maxy = my_tank.y + haf_h;
                var bx, by, bw = 50, hw = bw / 2;
                var w_bw = 36, w_hw = w_bw / 2;
                var speed_w = Math.round( dfd_speed_t / bw);
                var pi2 = 6.28;

                //objs.clear();
                //objs.lineStyle(1, 0x22ff00, 1);
                //objs.drawCircle(my_tank.x, my_tank.y, 4)

                var t_r, t_p ,g_r;

                for (var gi in jiangpins) {
                    gs = jiangpins[gi];
                    if (!gs.model) {
                        gs.model = new PIXI.Container();
                        gs.body = new PIXI.Sprite(textures[gs.img]);
                        gs.body.anchor.set(0.5, 0.5)
                        gs.model.addChild(gs.body)
                        if (gs.t == 0) {
                            var nmodel = new PIXI.Text("x" + gs.z, {
                                fontFamily: 'Arial',
                                fontSize: 14,
                                fill: 0xffffff,
                                align: 'center',
                            })
                            nmodel.y = 0;
                            nmodel.x = 16;
                            nmodel.alpha = 1;
                            nmodel.anchor.set(0, 0);
                            gs.model.addChild(nmodel)
                        }
                        jiangpincont.addChild(gs.model);
                    }
                    gs.model.x = gs.x;
                    gs.model.y = gs.y;
                    //gs.model.rotation = Math.PI * gs.r / 180;
                    g_r = gs.body.rotation;
                    g_r += 0.01;
                    gs.body.rotation = g_r > pi2 ? 0 : g_r;
                    gs.body.scale.set(gs.chi_ct);
                }

                for (var wi in wutis) {
                    wt = wutis[wi];
                    if (!wt.model) {
                        wt.model = new PIXI.Container();
                        wuticont.addChild(wt.model);
                        wt.body = new PIXI.Sprite(textures[wt.img]);
                        wt.body.anchor.set(0.5, 0.5)
                        wt.graphi = new PIXI.Graphics();
                        wt.model.addChild(wt.graphi)
                        wt.model.addChild(wt.body)
                    }
                    wt.model.x = wt.x;
                    wt.model.y = wt.y;
                    //gs.model.rotation = Math.PI * gs.r / 180;
                    g_r = wt.body.rotation;
                    g_r -= 0.03;
                    wt.body.rotation = g_r < 0 ? pi2 : g_r;

                    if (wt.drowh != wt.h) {
                        wt.graphi.clear();
                        if (wt.h > 0) {
                            by = 24;
                            bx = -w_hw;
                            wt.graphi.lineStyle(2, 0x5A1F1F, 1);
                            wt.graphi.moveTo(bx, by).lineTo(bx + w_bw, by);
                            wt.graphi.lineStyle(2, 0xCE1313, 1);
                            wt.graphi.moveTo(bx, by).lineTo(bx + (w_bw * wt.h / wt.mh), by);
                        }
                        wt.drowh = wt.h
                    }
                }



                for (var fi in tankes) {
                    fj = tankes[fi];
                    if (!fj.model) {
                        fj.model = new PIXI.Container();
                        tankecont.addChild(fj.model);

                        fj.body = new PIXI.Sprite(textures["fj" + fj.skin]);
                        fj.body.anchor.set(0.5, 0.5)
                        fj.model.addChild(fj.body);
                        fj.graphi = new PIXI.Graphics();
                        fj.model.addChild(fj.graphi)
                    }

                    if (!fj.paota) {
                        fj.paota = new PIXI.Sprite(textures[GUNS[fj.gun].p]);
                        fj.paota.anchor.set(0.5, 0.5)
                        fj.model.addChild(fj.paota);
                    }

                    if (!fj.n_model && fj.n) {
                        var nmodel = new PIXI.Text(fj.n,{
                            fontFamily: 'Arial',
                            fontSize: 13,
                            fill: 0xaaaaaa,
                            align: 'left',
                            })
                        nmodel.x = 30;
                        nmodel.y = 5;
                        nmodel.alpha = 1;
                        //nmodel.anchor.set(0, 0);

                        fj.model.addChild(nmodel);
                        fj.n_model = true;
                    }

                    fj.model.x = fj.x;
                    fj.model.y = fj.y;

                    if (fj.c_r != fj.r) {
                        if (fj.r - fj.c_r > 180) {
                            fj.c_r += 360;
                        } else if (fj.r - fj.c_r < -180) {
                            fj.c_r -= 360;
                        }
                        t_r = fj.r - fj.c_r;
                        t_r > 30 ? t_r = 30 : t_r < -30 ? t_r = -30 : 0;
                        fj.c_r += t_r / 6;
                        fj.body.rotation = Math.PI * fj.c_r / 180;
                    }
                    if (fj.c_p != fj.p) {
                        if (fj.p - fj.c_p > 180) {
                            fj.c_p += 360;
                        } else if (fj.p - fj.c_p < -180) {
                            fj.c_p -= 360;
                        }
                        t_p = fj.p - fj.c_p;
                        fj.c_p += t_p / 6;
                        fj.paota.rotation = Math.PI * fj.c_p / 180;
                    }

                    //绘制 生命条
                    fj.graphi.clear();
                    if (fj.h>0 && fj.x > minx && fj.x < maxx && fj.y > miny && fj.y < maxy) {
                        by = 30;
                        bx = -hw;
                        fj.graphi.clear();
                        fj.graphi.lineStyle(4, 0x1C5428, 1);
                        fj.graphi.moveTo(bx, by).lineTo(bx + bw, by);
                        fj.graphi.lineStyle(4, 0x38CE13, 1);
                        fj.graphi.moveTo(bx, by).lineTo(bx + (bw * fj.h / dfd_h), by);

                        if (fj.v_t > now_time) {
                            by += 5;
                            fj.graphi.lineStyle(4, 0x2b8fd6, 1);
                            fj.graphi.moveTo(bx, by).lineTo(bx + Math.floor((fj.v_t - now_time) / speed_w), by);
                        }

                        //by = fj.y + 30;
                        //bx = fj.x - hw;
                        //objs.lineStyle(4, 0x1C5428, 1);
                        //objs.moveTo(bx, by).lineTo(bx + bw, by);
                        //objs.lineStyle(4, 0x38CE13, 1);
                        //objs.moveTo(bx, by).lineTo(bx + (bw * fj.h / dfd_h), by);

                        //if (fj.v_t > now_time) {
                        //    by += 5;
                        //    objs.lineStyle(4, 0x2b8fd6, 1);
                        //    objs.moveTo(bx, by).lineTo(bx + Math.floor((fj.v_t - now_time) / speed_w), by);
                        //}

                    }
                    if (fj.h <= 0) {
                        fj.model.scale.set(Math.min(fj.model.scale.x + 0.02, 1.5));
                        fj.model.alpha -= 0.01;
                        if (fj.model.alpha <= 0.05) {
                            fj.a = false;
                        }
                    }
                }

                for (var i = 0; i < zidans.length; i++) {
                    zd = zidans[i];
                    if (!zd.model) {
                        zd.model = new PIXI.Sprite(textures[zd.img]);
                        zd.model.anchor.set(0.5, 0.5)
                        zidancont.addChild(zd.model);
                    }
                    zd.model.x = zd.x;
                    zd.model.y = zd.y;
                    zd.model.rotation = Math.PI * zd.r / 180;
                    zd.model.visible = zd.a;
                }

            }

            function update() {
                requestAnimationFrame(update);
                if (pageData.sysstate != 2) {
                    return;
                }
                var now_time = new Date().getTime();

                tick();
                stage.x = haf_w - my_tank.x;
                stage.y = haf_h - my_tank.y;

                updateBG();
                updateObjShow(now_time);
                renderer.render(scene)
            }

            var touch_bx, touch_by;
            var js_touch_bar = $("#js-touch-bar");
            var updateKeyState = function () {
                var up, down, left, right, x, y, rotate = 0, fire = false;
                return function (type) {
                    if (pageData.sysstate != 2) {
                        return;
                    }
                    if (type == 1) {
                        up = presskeys[87] || presskeys[38];
                        down = presskeys[83] || presskeys[40];
                        left = presskeys[65] || presskeys[37];
                        right = presskeys[68] || presskeys[39];

                        y = up && !down ? -1 : (!up && down ? 1 : 0);
                        x = left && !right ? -1 : (!left && right ? 1 : 0);
                        var newr = 360;
                        if (x > 0) {
                            if (y > 0) {
                                newr = 45;
                            } else if (y < 0) {
                                newr = 315;
                            } else {
                                newr = 360;
                            }
                        } else if (x < 0) {
                            if (y > 0) {
                                newr = 135;
                            } else if (y < 0) {
                                newr = 225;
                            } else {
                                newr = 180;
                            }
                        } else {
                            if (y > 0) {
                                newr = 90;
                            } else if (y < 0) {
                                newr = 270;
                            } else {
                                newr = 0;
                            }
                        }
                        if (newr != rotate) {
                            Tank.imove(newr);
                            //game_imove_event(newr);
                            rotate = newr;
                        }
                    } else if (type == 2) {     //开火
                        var f = presskeys[32] || presskeys["f"];
                        if (f != fire) {
                            fire = f;

                        }
                    }
                }
            }();
            function addEvents() {

                $(document).on("keydown", function (e) {
                    if (presskeys[e.which]) {
                        return;
                    }
                    presskeys[e.which] = true;
                    if (e.which == 32) {
                        updateKeyState(2);
                    } else {
                        updateKeyState(1);
                    }
                });
                $(document).on("keyup", function (e) {
                    presskeys[e.which] = false;
                    if (e.which == 32) {
                        updateKeyState(2);
                    } else {
                        updateKeyState(1);
                    }
                    if (e.which == 13 && pageData.sysstate == 2) {
                        js_chat_input.focus();
                    }

                });

                canvas_div.addEventListener("touchstart", pagemousemove);
                canvas_div.addEventListener("touchmove", pagemousemove);
                canvas_div.addEventListener("mousemove", pagemousemove);

                canvas_div.addEventListener("mousedown", gameMouseEvent);
                canvas_div.addEventListener("mouseup", gameMouseEvent);
                canvas_div.addEventListener("touchstart", gameMouseEvent);
                canvas_div.addEventListener("touchend", gameMouseEvent);
                function pagemousemove(e) {
                    var x = 0, y = 0;
                    if (e.type == "mousemove") {
                        x = e.pageX;
                        y = e.pageY;
                    } else if (e.type == "touchstart" || e.type == "touchmove") {
                        var t = e.touches[0], t2;
                        for (var i = 1; i < e.touches.length; i++) {
                            t2 = e.touches[i];
                            if (t2.pageX > t.pageX) {
                                t = t2;
                            }
                        }
                        x = t.pageX;
                        y = t.pageY;
                    }

                    var dx = x - (w_w / 2);
                    var dy = y - (w_h / 2);
                    var dr = Math.round(tools.vector2deg(dx, dy));
                    //game_ipao_event(dr % 360);
                    Tank.ipao(dr % 360)
                }

                function gameMouseEvent(e) {
                    if (e.type == "mousedown") {
                        Tank.ifire(true)
                    } else if (e.type == "mouseup") {
                        Tank.ifire(false)
                    } else if (e.type == "touchstart") {
                        Tank.ifire(true)
                    } else if (e.type == "touchend") {
                        Tank.ifire(false)
                    }
                }
                var is_moving = false;
                function touch_control(e) {
                    if (e.type == "touchmove" || e.type == "touchstart") {
                        is_moving = true;
                        var t = e.touches[0], t2;
                        console.log(e.touches)
                        for (var i = 1; i < e.touches.length; i++) {
                            t2 = e.touches[i];
                            if (t2.pageX < t.pageX) {
                                t = t2;
                            }
                        }

                        var tx = t.pageX;
                        var ty = t.pageY;
                        var dx = tx - touch_bx;
                        var dy = ty - touch_by;
                        var dr = Math.round(tools.vector2deg(dx, dy));
                        Tank.imove(dr);
                        e.stopPropagation();
                        e.preventDefault();
                    } else {
                        is_moving = false;
                        Tank.imove(0);
                    }
                }
                if (!js_is_pc) {
                    
                    js_touch_bar[0].addEventListener("touchstart", touch_control)
                    js_touch_bar[0].addEventListener("touchmove", touch_control)
                    js_touch_bar[0].addEventListener("touchend", touch_control)

                    

                }

            }

            function resize() {
                w_w = canvas_div.clientWidth;
                w_h = canvas_div.clientHeight;

                //w = h = 1200
                //var scale = w_w / w_h;
                //if (scale > 1) {
                //    h = w / scale;
                //} else{
                //    w = h * scale;
                //}
                //js_head_bar.css("left", 160 * w_w / w + "px");

                w = w_w;
                h = w_h;

                haf_w = w >> 1;
                haf_h = h >> 1;

                renderer.resize(w, h);
                tilingSprite.width = w;
                tilingSprite.height = h;
                //tilingSprite.x = haf_w;
                //tilingSprite.y = haf_h;

                if (!js_is_pc) {
                    var ofst = js_touch_bar.offset();
                    touch_bx = Math.round(ofst.left) + 34;
                    touch_by = Math.round(ofst.top) + 34;
                }

            }
            function init() {
                resize();
                rebase();
                addEvents();
                update();

            }
            init();
            window.onresize = resize;
        })();


    </script>



    {% endjsmin %}
    {% endblock %}
</body>
</html>